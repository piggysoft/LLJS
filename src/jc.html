<html>
  <head>
    <title>JS*</title>
  </head>
  <script>
    print = function (x) {
      console.info(x);
    }
  </script>
  <script src="vendor/jquery-1.6.4.js"></script>
  <script src="util.js"></script>
  <script src="peg.js"></script>
  <script src="parser.js"></script>
  <script src="compiler.js"></script>
  <script src="memory.js"></script>
  <body>
    <script>

  var FileReader = (function fileReader() {

  function constructor(url, responseType) {
    this.url = url;
    this.responseType = responseType || "arraybuffer";
  }

  constructor.prototype = {
    readAll: function(progress, complete) {
      var xhr = new XMLHttpRequest();
      var async = true;
      xhr.open("GET", this.url, async);
      xhr.responseType = this.responseType;
      if (progress) {
        xhr.onprogress = function (event) {
          progress(xhr.response, event.loaded, event.total);
        };
      }
      xhr.onreadystatechange = function (event) {
        if (xhr.readyState === 4) {
          complete(xhr.response);
        }
      }
      xhr.setRequestHeader("If-Modified-Since", "Fri, 01 Jan 1960 00:00:00 GMT"); // no-cache
      xhr.send(null);
    }
  };
  return constructor;
})();

  var extern = {trace: function (x) {
    console.info(x);
  }};

  var parser;
  new FileReader("jc.peg", "text").readAll(null, function (text) {
    // parser = P.buildParser(text, { trackLineAndColumn: true});
    new FileReader("tests/simple.jc", "text").readAll(null, function (source) {
      var com = compile(source);
      document.write("<pre>" + com + "</pre>");

      var o = new Function (com)();

var start = new Date();

var malloc = extern.malloc;
var free = extern.free;

function time (fn) {
  var start = new Date();
  fn();
  return new Date() - start;
}

var mTotal = 0, fTotal = 0;

var sum = 0;
for (var i = 0; i < 20; i++) {
  var ptrs = [];
  mTotal += time(function () {
    for (var j = 0; j < 100000; j++) {
      ptrs[j] = malloc(20);
    }
  });

  fTotal += time(function () {
    for (var j = 0; j < 100000; j++) {
      free(ptrs[j]);
    }
  });
}

console.info("Malloc: " + mTotal + ", Free: " + fTotal);

console.info("Done in " + (new Date() - start) + " checksum: " + sum);

    });
  });
    </script>
  </body>
</html>
